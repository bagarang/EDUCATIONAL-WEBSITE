<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENGLISH IS FUN - SD Travel Edition</title>
    
    <!-- Import Font Gaya Tulisan Tangan (Doodle Style) -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4A90E2; /* Langit Biru */
            --secondary-color: #F5A623; *//* Matahari Kuning */
            --accent-color: #7ED321; /* Rumput Hijau */
            --paper-color: #FDFBF7;
            --doodle-border: 2px solid #333;
            --shadow: 4px 4px 0px rgba(0,0,0,0.2);
            --font-main: 'Patrick Hand', cursive;
            --font-bold: 'Comic Neue', cursive;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* Mencegah seleksi teks agar terasa seperti app */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: #E0F7FA;
            background-image: 
                radial-gradient(#B2EBF2 15%, transparent 16%),
                radial-gradient(#B2EBF2 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* Container Utama dengan gaya "Travel Journal" */
        #game-container {
            width: 90%;
            max-width: 600px;
            height: 90vh;
            background-color: var(--paper-color);
            border: var(--doodle-border);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; /* Bentuk organik */
            box-shadow: 10px 10px 0px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 20px;
        }

        /* Hiasan Doodle CSS */
        .doodle-tape {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 35px;
            background-color: rgba(255, 255, 255, 0.6);
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            transform: translateX(-50%) rotate(-2deg);
        }

        /* Layar (Screens) */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Tipografi & Elemen UI */
        h1 {
            font-family: var(--font-bold);
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #fff, 4px 4px 0px #000;
            letter-spacing: 2px;
        }

        h2 {
            font-family: var(--font-bold);
            color: #333;
            margin: 10px 0;
        }

        .input-group {
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            font-family: var(--font-main);
            border: 2px dashed #999;
            border-radius: 10px;
            background: #fff;
            outline: none;
            text-align: center;
            transition: 0.3s;
        }

        input[type="text"]:focus {
            border-color: var(--primary-color);
            background-color: #EAF6FF;
        }

        /* Tombol */
        .btn {
            display: block;
            width: 200px;
            padding: 12px 20px;
            margin: 10px auto;
            font-family: var(--font-bold);
            font-size: 1.2rem;
            color: white;
            background-color: var(--secondary-color);
            border: none;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            cursor: pointer;
            box-shadow: 0 4px 0 #D35400;
            transition: transform 0.1s, box-shadow 0.1s;
            text-decoration: none;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #D35400;
        }

        .btn-green { background-color: var(--accent-color); box-shadow: 0 4px 0 #5CAD00; }
        .btn-blue { background-color: var(--primary-color); box-shadow: 0 4px 0 #2C3E50; }
        .btn-red { background-color: #FF6B6B; box-shadow: 0 4px 0 #C0392B; }
        .btn-small { width: auto; font-size: 1rem; padding: 8px 16px; display: inline-block; margin: 5px; }

        /* Elemen Game (Soal & Timer) */
        .hud {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .timer-bar-container {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .timer-bar {
            height: 100%;
            background-color: var(--accent-color);
            width: 100%;
            transition: width 1s linear;
        }

        .question-image {
            font-size: 6rem; /* Menggunakan Emoji sebagai gambar utama */
            margin: 20px 0;
            filter: drop-shadow(3px 3px 0px rgba(0,0,0,0.2));
            animation: bounce 2s infinite;
        }

        .question-image img {
            max-width: 100%;
            border-radius: 15px;
            border: 3px solid #333;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }

        .option-btn {
            background: white;
            border: 2px solid #333;
            padding: 15px;
            border-radius: 10px;
            font-family: var(--font-main);
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 3px 3px 0px #ccc;
            transition: 0.2s;
        }

        .option-btn:hover {
            background: #f0f0f0;
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0px #ccc;
        }

        /* Leaderboard Style */
        .leaderboard-list {
            list-style: none;
            padding: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #333;
            border-radius: 10px;
            background: white;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px dashed #ccc;
        }

        .leaderboard-item:nth-child(1) { background-color: #FFD700; } /* Gold */
        .leaderboard-item:nth-child(2) { background-color: #C0C0C0; } /* Silver */
        .leaderboard-item:nth-child(3) { background-color: #CD7F32; } /* Bronze */

        /* Modal / Popup Overlay */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #333;
            text-align: center;
            max-width: 80%;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .feedback-text {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .correct { color: var(--accent-color); }
        .wrong { color: #FF6B6B; }

        /* Pesan Stage Selesai */
        .stage-complete-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Footer */
        .footer-nav {
            margin-top: auto;
            padding-top: 20px;
        }

    </style>
</head>
<body>

    <div id="game-container">
        <!-- Pita Hiasan -->
        <div class="doodle-tape"></div>

        <!-- ================= MAIN MENU ================= -->
        <div id="menu-screen" class="screen active">
            <h1>ENGLISH IS FUN</h1>
            <div class="question-image">‚úàÔ∏è üó∫Ô∏è üåç</div>
            
            <div class="input-group">
                <input type="text" id="player-name" placeholder="Masukkan Nama Kamu..." maxlength="15">
            </div>

            <button class="btn btn-blue" onclick="startGame()">START</button>
            <button class="btn btn-green" onclick="showLeaderboard()">LEADERBOARD</button>
            
            <div class="footer-nav">
                <button class="btn btn-red btn-small" onclick="goToIndex()">KEMBALI</button>
            </div>
        </div>

        <!-- ================= GAME PLAY SCREEN ================= -->
        <div id="game-screen" class="screen">
            <div class="hud">
                <span id="score-display">Score: 0</span>
                <span id="stage-display">Stage 1 - 1</span>
            </div>
            
            <div class="timer-bar-container">
                <div id="timer-bar" class="timer-bar"></div>
            </div>

            <!-- Area Konten Soal (Berubah sesuai tipe) -->
            <div id="question-area">
                <!-- Image Placeholder -->
                <div id="q-image-container" class="question-image"></div>
                
                <!-- Opsi Jawaban (Stage 1-15) -->
                <div id="options-container" class="options-grid"></div>

                <!-- Input Teks (Stage 16-20) -->
                <div id="input-container" style="display: none;">
                    <input type="text" id="answer-input" placeholder="Ketik jawaban dalam bahasa Inggris..." autocomplete="off">
                    <button class="btn btn-green" style="margin-top:10px" onclick="submitTextAnswer()">Submit</button>
                </div>
            </div>
        </div>

        <!-- ================= LEADERBOARD SCREEN ================= -->
        <div id="leaderboard-screen" class="screen">
            <h2>üèÜ TOP TRAVELERS üèÜ</h2>
            <ul id="leaderboard-list" class="leaderboard-list">
                <!-- List Item injected by JS -->
            </ul>
            <button class="btn btn-blue" onclick="showMenu()">BACK TO MENU</button>
        </div>

        <!-- ================= MODAL FEEDBACK (Benar/Salah/Stage End) ================= -->
        <div id="modal" class="modal-overlay">
            <div class="modal-content">
                <div id="modal-icon" style="font-size: 4rem;">üéâ</div>
                <div id="modal-text" class="feedback-text">Correct!</div>
                <div id="modal-score-change" style="font-size: 1.2rem; margin-bottom: 20px;">+100</div>
                
                <div id="modal-actions">
                    <!-- Tombol dinamis akan disini -->
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPT LOGIC -->
    <script>
        // ================= DATA SOAL =================
        // Kita menggunakan Emoji dan data sederhana untuk memastikan game stabil tanpa load gambar eksternal yang lambat/bermasalah.
        // Tema: Travel & Objects

        const vocabObjects = [
            { word: "Airplane", emoji: "‚úàÔ∏è", opts: ["Airplane", "Bird", "Car", "Train"] },
            { word: "Map", emoji: "üó∫Ô∏è", opts: ["Map", "Paper", "Book", "Ball"] },
            { word: "Backpack", emoji: "üéí", opts: ["Backpack", "Shoe", "Hat", "Bag"] },
            { word: "Camera", emoji: "üì∑", opts: ["Camera", "Phone", "Glass", "Watch"] },
            { word: "Passport", emoji: "üìò", opts: ["Passport", "Comic", "Note", "Money"] },
            { word: "Ticket", emoji: "üé´", opts: ["Ticket", "Money", "Card", "Leaf"] },
            { word: "Suitcase", emoji: "üß≥", opts: ["Suitcase", "Box", "House", "Table"] },
            { word: "Boat", emoji: "‚õµ", opts: ["Boat", "Bike", "Car", "Plane"] },
            { word: "Mountain", emoji: "üèîÔ∏è", opts: ["Mountain", "Hill", "Stone", "Wall"] },
            { word: "Beach", emoji: "üèñÔ∏è", opts: ["Beach", "Park", "Pool", "Snow"] },
            { word: "Hotel", emoji: "üè®", opts: ["Hotel", "House", "School", "Hospital"] },
            { word: "Sun", emoji: "‚òÄÔ∏è", opts: ["Sun", "Moon", "Star", "Lamp"] },
            { word: "Bus", emoji: "üöå", opts: ["Bus", "Car", "Train", "Truck"] },
            { word: "Money", emoji: "üíµ", opts: ["Money", "Paper", "Letter", "Cloth"] },
            { word: "Compass", emoji: "üß≠", opts: ["Compass", "Clock", "Watch", "Circle"] },
            { word: "Glasses", emoji: "üï∂Ô∏è", opts: ["Glasses", "Eyes", "Window", "Sun"] }
        ];

        const vocabActions = [
            { word: "Swim", emoji: "üèä", opts: ["Swim", "Run", "Jump", "Fly"] },
            { word: "Run", emoji: "üèÉ", opts: ["Run", "Walk", "Sit", "Sleep"] },
            { word: "Eat", emoji: "üçΩÔ∏è", opts: ["Eat", "Cook", "Clean", "Drink"] },
            { word: "Sleep", emoji: "üõå", opts: ["Sleep", "Stand", "Fight", "Dance"] },
            { word: "Drive", emoji: "üöó", opts: ["Drive", "Walk", "Ride", "Fly"] },
            { word: "Read", emoji: "üìñ", opts: ["Read", "Write", "Draw", "Listen"] },
            { word: "Take Photo", emoji: "üì∏", opts: ["Take Photo", "See", "Look", "Watch"] },
            { word: "Fly", emoji: "ü¶Ö", opts: ["Fly", "Swim", "Crawl", "Walk"] },
            { word: "Buy", emoji: "üõçÔ∏è", opts: ["Buy", "Sell", "Give", "Take"] },
            { word: "Listen", emoji: "üéß", opts: ["Listen", "Speak", "Shout", "Sing"] },
            { word: "Climb", emoji: "üßó", opts: ["Climb", "Fall", "Jump", "Slide"] },
            { word: "Explore", emoji: "üî≠", opts: ["Explore", "Ignore", "Hide", "Stay"] }
        ];

        const sentences = [
            { q: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ‚úàÔ∏è üóº", a: ["family goes to japan", "the family is flying"], hint: "Family is travelling" },
            { q: "üèä‚Äç‚ôÇÔ∏è üåä üê†", a: ["he swims in the sea", "swimming in the ocean"], hint: "Activity in water" },
            { q: "üì∏ ü¶Å ü¶Å", a: ["taking photo of lions", "photo a lion"], hint: "Camera action" },
            { q: "üçï üçï üòã", a: ["eating pizza", "they eat pizza"], hint: "Food consumption" },
            { q: "üìö üè´ üéí", a: ["study at school", "reading books"], hint: "School activity" },
            { q: "üèîÔ∏è ‚ùÑÔ∏è ü•∂", a: ["cold mountain", "it is snowing"], hint: "Weather condition" },
            { q: "üöå üõ£Ô∏è üèôÔ∏è", a: ["bus in the city", "driving bus"], hint: "Transport in city" },
            { q: "üåô üõå üí§", a: ["sleep at night", "go to sleep"], hint: "Night time" },
            { q: "üé∏ üéµ üëÇ", a: ["playing guitar", "listen to music"], hint: "Music instrument" },
            { q: "‚òï üì± üí¨", a: "drinking coffee", hint: "Relaxing" }
        ];

        // ================= GAME VARIABLES =================
        let state = {
            screen: 'menu',
            playerName: '',
            score: 0,
            stage: 1,
            level: 1, // 1-5
            timer: 15,
            timerInterval: null,
            currentQuestion: null,
            isProcessing: false // prevent double clicks
        };

        const TOTAL_STAGES = 20;
        const LEVELS_PER_STAGE = 5;

        // ================= AUDIO ENGINE (Web Audio API) =================
        // Membuat musik monotone easy listening tanpa file eksternal
        let audioCtx;
        let isMusicPlaying = false;
        let nextNoteTime = 0;
        let noteIndex = 0;
        
        // Skala nada C Major Pentatonic (C, D, E, G, A)
        const notes = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25]; 

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playTone(freq, duration) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sine'; // Monotone lembut
            osc.frequency.value = freq;
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            
            // Envelope ADSR sederhana agar tidak 'klik'
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.1); // Attack
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration); // Release
            
            osc.stop(audioCtx.currentTime + duration);
        }

        function scheduler() {
            if (!isMusicPlaying) return;
            
            // Mainkan loop notanya pelan-pelan
            if (nextNoteTime <= audioCtx.currentTime + 0.1) {
                playTone(notes[noteIndex], 2); // Nada panjang 2 detik
                noteIndex = (noteIndex + 1) % notes.length;
                nextNoteTime = audioCtx.currentTime + 1.5; // Jarak antar nada (slow tempo)
            }
            window.requestAnimationFrame(scheduler);
        }

        function startMusic() {
            initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isMusicPlaying = true;
            nextNoteTime = audioCtx.currentTime;
            scheduler();
        }

        function stopMusic() {
            isMusicPlaying = false;
        }

        function playSoundEffect(type) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'correct') {
                // Ting! (High C -> E)
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(659.25, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'wrong') {
                // Buzz (Low Gb)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(185.00, now); // F#
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'click') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.02, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            }
        }

        // ================= GAME LOGIC =================

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            playSoundEffect('click');
        }

        function goToIndex() {
            window.location.href = 'index.html';
        }

        function startGame() {
            const nameInput = document.getElementById('player-name');
            if (nameInput.value.trim() === "") {
                // Input shake animation sederhana
                nameInput.style.borderColor = "red";
                setTimeout(() => nameInput.style.borderColor = "#999", 500);
                return;
            }

            state.playerName = nameInput.value;
            state.score = 0;
            state.stage = 1;
            state.level = 1;
            
            startMusic(); // Mulai musik easy listening
            loadStage();
            switchScreen('game-screen');
        }

        function loadStage() {
            state.isProcessing = false;
            document.getElementById('score-display').innerText = `Score: ${state.score}`;
            document.getElementById('stage-display').innerText = `Stage ${state.stage} - Level ${state.level}`;
            document.getElementById('answer-input').value = ""; // Reset input
            
            // Setup UI berdasarkan Stage
            const imgContainer = document.getElementById('q-image-container');
            const optContainer = document.getElementById('options-container');
            const inputContainer = document.getElementById('input-container');

            optContainer.innerHTML = '';
            optContainer.style.display = 'grid';
            inputContainer.style.display = 'none';

            // Logika Generate Soal
            if (state.stage <= 8) {
                // Stage 1-8: Objects (Pilihan Ganda)
                const qData = vocabObjects[Math.floor(Math.random() * vocabObjects.length)];
                state.currentQuestion = { type: 'choice', answer: qData.word, options: qData.opts };
                imgContainer.innerText = qData.emoji;
                
                qData.opts.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = opt;
                    btn.onclick = () => checkAnswer(opt);
                    optContainer.appendChild(btn);
                });

            } else if (state.stage <= 15) {
                // Stage 9-15: Actions (Pilihan Ganda)
                const qData = vocabActions[Math.floor(Math.random() * vocabActions.length)];
                state.currentQuestion = { type: 'choice', answer: qData.word, options: qData.opts };
                imgContainer.innerText = qData.emoji;

                qData.opts.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = opt;
                    btn.onclick = () => checkAnswer(opt);
                    optContainer.appendChild(btn);
                });

            } else {
                // Stage 16-20: Sentences (Input Teks)
                // Kita ambil data sentence secara random atau looping
                const qIndex = (state.stage + state.level) % sentences.length;
                const qData = sentences[qIndex];
                state.currentQuestion = { 
                    type: 'text', 
                    answers: qData.a, // array of accepted answers
                    hint: qData.hint
                };
                
                imgContainer.innerText = qData.q;
                imgContainer.style.fontSize = "4rem"; // Sedikit lebih kecil untuk scene
                optContainer.style.display = 'none';
                inputContainer.style.display = 'block';
                
                // Hint kecil
                const hintEl = document.createElement('div');
                hintEl.id = 'hint-text';
                hintEl.style.color = '#888';
                hintEl.style.marginBottom = '5px';
                hintEl.innerText = `Hint: ${state.currentQuestion.hint}`;
                inputContainer.insertBefore(hintEl, document.getElementById('answer-input'));
            }

            startTimer();
        }

        function startTimer() {
            clearInterval(state.timerInterval);
            state.timer = 15;
            const bar = document.getElementById('timer-bar');
            bar.style.width = '100%';
            bar.style.backgroundColor = '#7ED321';

            state.timerInterval = setInterval(() => {
                state.timer--;
                const percentage = (state.timer / 15) * 100;
                bar.style.width = percentage + '%';

                // Warna berubah saat waktu menipis
                if (state.timer < 5) bar.style.backgroundColor = '#FF6B6B';

                if (state.timer <= 0) {
                    clearInterval(state.timerInterval);
                    handleTimeOut();
                }
            }, 1000);
        }

        function handleTimeOut() {
            if (state.isProcessing) return;
            state.isProcessing = true;
            playSoundEffect('wrong');
            updateScore(-50);
            showModal("Time's Up!", "‚è∞", -50, "retry");
        }

        function checkAnswer(userAnswer) {
            if (state.isProcessing) return;
            state.isProcessing = true;
            clearInterval(state.timerInterval);

            const correctAnswer = state.currentQuestion.answer;
            
            if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                // BENAR
                playSoundEffect('correct');
                updateScore(100);
                
                // Cek apakah level terakhir stage
                if (state.level === LEVELS_PER_STAGE) {
                    showModal("Stage Complete!", "üéâ", 100, "stageComplete");
                } else {
                    showModal("Correct!", "‚úÖ", 100, "nextLevel");
                }
            } else {
                // SALAH
                playSoundEffect('wrong');
                updateScore(-50);
                showModal("Wrong Answer!", "‚ùå", -50, "retry");
            }
        }

        function submitTextAnswer() {
            if (state.isProcessing) return;
            const input = document.getElementById('answer-input');
            const userText = input.value.trim();
            
            if (userText === "") return;

            state.isProcessing = true;
            clearInterval(state.timerInterval);

            // Cek jawaban (fuzzy check: apakah mengandung kata kunci)
            // Untuk simplifikasi game anak SD, kita cek kesamaan string (ignore case) terhadap array jawaban yang diterima
            const isCorrect = state.currentQuestion.answers.some(ans => 
                userText.toLowerCase() === ans.toLowerCase()
            );

            if (isCorrect) {
                playSoundEffect('correct');
                updateScore(100);
                if (state.level === LEVELS_PER_STAGE) {
                    showModal("Stage Complete!", "üéâ", 100, "stageComplete");
                } else {
                    showModal("Correct!", "‚úÖ", 100, "nextLevel");
                }
            } else {
                playSoundEffect('wrong');
                updateScore(-50);
                showModal("Wrong Answer!", "‚ùå", -50, "retry");
            }
        }

        function updateScore(delta) {
            state.score += delta;
            document.getElementById('score-display').innerText = `Score: ${state.score}`;
        }

        // ================= MODAL & NAVIGATION =================

        function showModal(title, icon, scoreChange, actionType) {
            const modal = document.getElementById('modal');
            const mText = document.getElementById('modal-text');
            const mIcon = document.getElementById('modal-icon');
            const mScore = document.getElementById('modal-score-change');
            const mActions = document.getElementById('modal-actions');

            mText.innerText = title;
            mIcon.innerText = icon;
            mScore.innerText = (scoreChange > 0 ? "+" : "") + scoreChange;
            mScore.className = scoreChange > 0 ? "correct" : "wrong";

            mActions.innerHTML = ''; // Reset tombol

            if (actionType === "nextLevel") {
                state.level++;
                const btn = document.createElement('button');
                btn.className = 'btn btn-green';
                btn.innerText = "Next Level ‚û°Ô∏è";
                btn.onclick = () => { closeModal(); loadStage(); };
                mActions.appendChild(btn);
            } else if (actionType === "retry") {
                // Level ulang, score berkurang sudah dikurangi sebelumnya
                const btn = document.createElement('button');
                btn.className = 'btn btn-red';
                btn.innerText = "Retry üîÑ";
                btn.onclick = () => { closeModal(); loadStage(); };
                mActions.appendChild(btn);
            } else if (actionType === "stageComplete") {
                // Selesai 1 stage (5 level)
                // Reset level untuk stage berikutnya
                const btnNext = document.createElement('button');
                btnNext.className = 'btn btn-green';
                btnNext.innerText = "Next Stage ‚û°Ô∏è";
                btnNext.onclick = () => { 
                    closeModal(); 
                    if(state.stage < TOTAL_STAGES) {
                        state.stage++;
                        state.level = 1;
                        loadStage();
                    } else {
                        gameCompleted(); // Game tamat semua stage
                    }
                };

                const btnMenu = document.createElement('button');
                btnMenu.className = 'btn btn-blue';
                btnMenu.innerText = "Main Menu üè†";
                btnMenu.onclick = () => { closeModal(); saveScore(); showMenu(); };

                mActions.appendChild(btnNext);
                mActions.appendChild(btnMenu);
            } else if (actionType === "gameOver") {
                 const btnMenu = document.createElement('button');
                btnMenu.className = 'btn btn-red';
                btnMenu.innerText = "Main Menu üè†";
                btnMenu.onclick = () => { closeModal(); saveScore(); showMenu(); };
                mActions.appendChild(btnMenu);
            }

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function gameCompleted() {
            playSoundEffect('correct');
            saveScore();
            showModal("YOU WIN!", "üèÜ", 0, "gameOver");
            // Override text sedikit
            document.getElementById('modal-text').innerText = "All Stages Completed!";
        }

        function showMenu() {
            stopMusic();
            document.getElementById('player-name').value = state.playerName; // Keep name
            switchScreen('menu-screen');
        }

        // ================= LEADERBOARD LOGIC =================
        function saveScore() {
            const leaderboard = JSON.parse(localStorage.getItem('ef_leaderboard')) || [];
            
            // Tambah score baru
            leaderboard.push({
                name: state.playerName,
                score: state.score,
                date: new Date().toLocaleDateString()
            });

            // Urutkan dari score tertinggi
            leaderboard.sort((a, b) => b.score - a.score);

            // Ambil top 10
            const top10 = leaderboard.slice(0, 10);

            localStorage.setItem('ef_leaderboard', JSON.stringify(top10));
        }

        function showLeaderboard() {
            playSoundEffect('click');
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';

            const data = JSON.parse(localStorage.getItem('ef_leaderboard')) || [];

            if (data.length === 0) {
                list.innerHTML = '<li class="leaderboard-item" style="justify-content:center;">Belum ada data</li>';
            } else {
                data.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'leaderboard-item';
                    
                    let medal = '';
                    if (index === 0) medal = 'ü•á ';
                    if (index === 1) medal = 'ü•à ';
                    if (index === 2) medal = 'ü•â ';

                    li.innerHTML = `
                        <span>${medal}#${index+1} ${item.name}</span>
                        <span>${item.score}</span>
                    `;
                    list.appendChild(li);
                });
            }
            switchScreen('leaderboard-screen');
        }

        // Event listener untuk tombol Enter pada input text
        document.getElementById('answer-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                submitTextAnswer();
            }
        });

    </script>
</body>
</html>
