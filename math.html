<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MATEMATIKA IS FUN</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-paper: #fdfbf7;
            --grid-color: rgba(0, 168, 255, 0.1);
            --margin-line: rgba(255, 121, 121, 0.5);
            --ink-black: #2d3436;
            --doodle-blue: #0984e3;
            --doodle-red: #d63031;
            --doodle-green: #00b894;
            --doodle-yellow: #fdcb6e;
            --border: 3px solid var(--ink-black);
            --shadow: 5px 5px 0px var(--ink-black);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg-paper);
            background-image: 
                linear-gradient(90deg, var(--margin-line) 2px, transparent 2px),
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 100%, 20px 20px, 20px 20px;
            background-position: 40px 0, 0 0, 0 0;
            height: 100dvh; width: 100vw;
            display: flex; justify-content: center; overflow: hidden;
        }

        #app-container {
            width: 100%; max-width: 450px;
            height: 100%; display: flex; flex-direction: column;
            padding: 15px; padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        .screen { display: none; flex-direction: column; height: 100%; width: 100%; animation: popIn 0.3s ease; }
        .screen.active { display: flex; }
        @keyframes popIn { from { transform: scale(0.98); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- HEADER --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0; }
        .badge {
            background: white; border: var(--border); padding: 5px 12px; border-radius: 50px;
            font-weight: 700; box-shadow: 3px 3px 0px var(--ink-black); font-size: 0.9rem;
        }

        .timer-container { width: 100%; height: 14px; background: white; border: var(--border); border-radius: 10px; overflow: hidden; margin: 10px 0; flex-shrink: 0; }
        .timer-fill { height: 100%; width: 100%; background: var(--doodle-green); transition: width 1s linear; }

        /* --- MAIN AREA (QUESTION) --- */
        .game-main {
            flex: 1; /* Mengambil sisa ruang */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 0; /* Penting agar flex-child bisa mengecil */
        }

        .q-card {
            background: white; border: var(--border); border-radius: 20px;
            width: 100%; max-height: 90%; /* Cegah tumpah */
            padding: 20px; text-align: center; box-shadow: var(--shadow);
            display: flex; flex-direction: column; justify-content: center;
        }

        #question-text { font-size: clamp(2.5rem, 8vh, 4rem); font-weight: 700; margin: 0; color: var(--ink-black); }
        #answer-view { font-size: 3.5rem; color: var(--doodle-blue); min-height: 70px; font-weight: 700; margin-top: 5px; }

        /* --- NUMPAD (LOCKED AT BOTTOM) --- */
        .numpad-container { flex-shrink: 0; padding-top: 10px; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

        .num-key {
            background: white; border: var(--border); padding: clamp(12px, 3vh, 18px); 
            font-size: 1.8rem; font-weight: 700; border-radius: 15px; 
            box-shadow: 3px 3px 0px var(--ink-black); cursor: pointer; transition: 0.1s;
            display: flex; justify-content: center; align-items: center;
        }
        .num-key:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px var(--ink-black); }
        .key-del { background: #ff7675; color: white; }
        .key-ok { background: var(--doodle-green); color: white; }

        /* --- EFFECTS --- */
        .wrong-ans { animation: shake 0.4s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); color: var(--doodle-red); }
            75% { transform: translateX(8px); }
        }

        /* --- MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-box { background: white; border: var(--border); border-radius: 25px; padding: 25px; width: 100%; max-width: 320px; text-align: center; box-shadow: 8px 8px 0px var(--ink-black); }
    </style>
</head>
<body id="body-bg">

<div id="app-container">

    <div id="screen-menu" class="screen active">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center; padding: 10px;">
            <h1 style="font-size: 2.5rem; color: var(--doodle-blue); transform: rotate(-1deg); margin-bottom: 25px;">Matematika<br>Pintar! ‚úèÔ∏è</h1>
            <input type="text" id="player-name" placeholder="Siapa namamu?" maxlength="12" 
                   style="width: 100%; font-size: 1.2rem; padding: 14px; border: var(--border); border-radius: 12px; text-align: center; margin-bottom: 15px; font-family: inherit;">
            
            <button class="num-key" onclick="startGame()" style="width:100%; background: var(--doodle-yellow); margin-bottom:12px;">MAIN SEKARANG</button>
            <button class="num-key" onclick="showLeaderboard()" style="width:100%; background: var(--doodle-green); color:white; font-size: 1.2rem; margin-bottom:12px;">LEADERBOARD</button>
            <button class="num-key" onclick="window.location.href='index.html'" style="width:100%; background: #636e72; color:white; font-size: 1.2rem;">KEMBALI</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="top-bar">
            <div class="badge">‚≠ê <span id="hud-score">0</span></div>
            <div class="badge" id="hud-stage">Stage 1</div>
            <button class="badge" style="cursor: pointer; background: #ff7675; color: white;" onclick="confirmQuit()">‚úï</button>
        </div>

        <div class="timer-container">
            <div id="timer-bar" class="timer-fill"></div>
        </div>

        <div class="game-main">
            <div class="q-card" id="q-card">
                <p id="question-text">0 + 0</p>
                <div id="answer-view">?</div>
            </div>
        </div>

        <div class="numpad-container">
            <div class="numpad">
                <button class="num-key" onclick="pressNum('1')">1</button>
                <button class="num-key" onclick="pressNum('2')">2</button>
                <button class="num-key" onclick="pressNum('3')">3</button>
                <button class="num-key" onclick="pressNum('4')">4</button>
                <button class="num-key" onclick="pressNum('5')">5</button>
                <button class="num-key" onclick="pressNum('6')">6</button>
                <button class="num-key" onclick="pressNum('7')">7</button>
                <button class="num-key" onclick="pressNum('8')">8</button>
                <button class="num-key" onclick="pressNum('9')">9</button>
                <button class="num-key key-del" onclick="pressClear()">C</button>
                <button class="num-key" onclick="pressNum('0')">0</button>
                <button class="num-key key-ok" onclick="checkAnswer()">OK</button>
            </div>
        </div>
    </div>

    <div id="screen-lb" class="screen">
        <h1 style="text-align: center; color: var(--doodle-blue); font-size: 2rem;">Papan Juara üèÜ</h1>
        <div id="lb-list" style="background: white; border: var(--border); border-radius: 15px; flex: 1; overflow-y: auto; padding: 10px; margin: 10px 0;"></div>
        <button class="num-key" onclick="showScreen('screen-menu')" style="width:100%; background: var(--doodle-yellow);">KEMBALI</button>
    </div>

</div>

<div id="modal-res" class="modal">
    <div class="modal-box">
        <h2 id="modal-title">Hebat!</h2>
        <div id="modal-score" style="font-size: 2.8rem; color: var(--doodle-blue); font-weight: 800; margin: 15px 0;">500</div>
        <p id="modal-msg" style="font-weight: 600; margin-bottom: 20px;">Kamu menyelesaikan Stage!</p>
        <button class="num-key" id="modal-btn" onclick="handleModal()" style="width: 100%; background: var(--doodle-green); color:white;">LANJUT</button>
    </div>
</div>

<script>
    const CONFIG = { time: 15, key: 'MATH_Doodle_V2' };
    let state = { name: '', score: 0, stage: 1, level: 1, timer: 15, timerId: null, ans: 0, input: '', isPlaying: false };

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function startGame() {
        const n = document.getElementById('player-name').value.trim();
        if(!n) return alert("Isi namamu dulu!");
        state = { ...state, name: n, score: 0, stage: 1, level: 1, isPlaying: true };
        document.getElementById('hud-score').innerText = '0';
        showScreen('screen-game');
        newQ();
    }

    function newQ() {
        state.input = '';
        document.getElementById('answer-view').innerText = '?';
        document.getElementById('answer-view').style.color = 'var(--doodle-blue)';
        
        let a, b, op = '+';
        if(state.stage <= 5) { a = r(15)+1; b = r(15)+1; state.ans = a + b; }
        else if(state.stage <= 10) { a = r(50)+5; b = r(40)+5; state.ans = a + b; }
        else { a = r(10)+2; b = r(10)+2; op = '√ó'; state.ans = a * b; }
        
        document.getElementById('question-text').innerText = `${a} ${op} ${b}`;
        startT();
    }

    function r(max) { return Math.floor(Math.random() * max); }

    function startT() {
        clearInterval(state.timerId);
        state.timer = CONFIG.time;
        updateTUI();
        state.timerId = setInterval(() => {
            state.timer--;
            updateTUI();
            if(state.timer <= 0) { clearInterval(state.timerId); feedback(false); }
        }, 1000);
    }

    function updateTUI() {
        const f = document.getElementById('timer-bar');
        f.style.width = (state.timer / CONFIG.time) * 100 + '%';
        f.style.background = state.timer <= 5 ? 'var(--doodle-red)' : 'var(--doodle-green)';
    }

    function pressNum(n) { if(state.input.length < 4) { state.input += n; document.getElementById('answer-view').innerText = state.input; } }
    function pressClear() { state.input = ''; document.getElementById('answer-view').innerText = '?'; }

    function checkAnswer() {
        if(!state.input) return;
        clearInterval(state.timerId);
        feedback(parseInt(state.input) === state.ans);
    }

    function feedback(correct) {
        const card = document.getElementById('q-card');
        const view = document.getElementById('answer-view');
        if(correct) {
            state.score += 100;
            view.style.color = 'var(--doodle-green)';
            setTimeout(next, 400);
        } else {
            card.classList.add('wrong-ans');
            view.style.color = 'var(--doodle-red)';
            view.innerText = state.ans;
            setTimeout(() => { card.classList.remove('wrong-ans'); next(); }, 1000);
        }
        document.getElementById('hud-score').innerText = state.score;
    }

    function next() {
        state.level++;
        if(state.level > 5) { showMod(); }
        else {
            document.getElementById('hud-stage').innerText = `Stage ${state.stage} (${state.level}/5)`;
            newQ();
        }
    }

    function showMod() {
        saveLB();
        document.getElementById('modal-score').innerText = state.score;
        document.getElementById('modal-res').style.display = 'flex';
    }

    function handleModal() {
        document.getElementById('modal-res').style.display = 'none';
        state.stage++; state.level = 1;
        document.getElementById('hud-stage').innerText = `Stage ${state.stage}`;
        newQ();
    }

    function saveLB() {
        let d = JSON.parse(localStorage.getItem(CONFIG.key)) || [];
        d.push({ n: state.name, s: state.score });
        d.sort((a,b) => b.s - a.s);
        localStorage.setItem(CONFIG.key, JSON.stringify(d.slice(0, 10)));
    }

    function showLeaderboard() {
        const l = document.getElementById('lb-list');
        const d = JSON.parse(localStorage.getItem(CONFIG.key)) || [];
        l.innerHTML = d.length ? d.map((x, i) => `
            <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:2px dashed #ccc; font-weight:600;">
                <span>#${i+1} ${x.n}</span>
                <span style="color:var(--doodle-blue)">${x.s}</span>
            </div>`).join('') : '<p style="text-align:center; padding:20px;">Belum ada skor.</p>';
        showScreen('screen-lb');
    }

    function confirmQuit() { if(confirm("Keluar game?")) location.reload(); }
</script>
</body>
</html>
